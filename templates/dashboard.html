{% extends "base.html" %}
{% block title %}Dashboard | Fire Alarm{% endblock %}

{% block body %}
<div class="container py-5">
  <div class="text-center mb-4">
    <img src="{{ url_for('static', filename='img/node.png') }}" alt="Fire Sensor" class="mb-2" style="width:80px;">
    <h1 class="text-white">Giám sát cảm biến</h1>
  </div>

  <div class="table-responsive bg-white rounded shadow-sm">
    <table class="table table-striped mb-0">
      <thead class="bg-danger text-white">
        <tr>
          <th>Địa chỉ thiết bị</th>
          <th>Nhiệt độ (°C)</th>
          <th>Độ ẩm (%)</th>
          <th>Nồng độ gas</th>
          <th>Dấu báo lửa</th>
        </tr>
      </thead>
      <tbody id="sensor-body">
        <tr>
          <td colspan="5" class="text-center text-muted">Đang tải dữ liệu...</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const firebaseConfig = {
      apiKey: "AIzaSyC13VZFz4aOjfPhpU7rqjZ-F8Ja-4MJkcc",
      authDomain: "pham-quoc-anh.firebaseapp.com",
      databaseURL: "https://pham-quoc-anh-default-rtdb.firebaseio.com",
      projectId: "pham-quoc-anh",
      storageBucket: "pham-quoc-anh.firebasestorage.app",
      messagingSenderId: "170698691755",
      appId: "1:170698691755:web:30a490b90e2c803410d3ee"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const tbody = document.getElementById('sensor-body');

    function updateTable(temp, humi, mq2, fire) {
      tbody.innerHTML = '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>ESP32</td>
        <td>${temp ?? '-'}</td>
        <td>${humi ?? '-'}</td>
        <td>${mq2 ?? '-'}</td>
        <td>${fire == 1 ? '<span class="text-danger fw-bold">Có</span>' : 'Không'}</td>
      `;
      tbody.appendChild(tr);
    }

    function loadAllValues() {
      Promise.all([
        db.ref('esp32_temp').get(),
        db.ref('esp32_humi').get(),
        db.ref('esp32_mq2').get(),
        db.ref('esp32_lm393').get()
      ]).then(([tempSnap, humiSnap, mq2Snap, fireSnap]) => {
        updateTable(
          tempSnap.val(),
          humiSnap.val(),
          mq2Snap.val(),
          fireSnap.val()
        );
      }).catch(err => {
        console.error("Lỗi khi đọc dữ liệu:", err);
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center text-danger">Không thể tải dữ liệu</td>
          </tr>
        `;
      });
    }

    loadAllValues();
    setInterval(loadAllValues, 5000);
  });
</script>
{% endblock %}
