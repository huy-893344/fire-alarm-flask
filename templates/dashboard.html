{% extends "base.html" %}
{% block title %}Dashboard | Fire Alarm{% endblock %}

{% block body %}
<div class="container py-5">
  <div class="text-center mb-4">
    <img src="{{ url_for('static', filename='img/node.png') }}" alt="Fire Sensor" class="mb-2" style="width:80px;">
    <h1 class="text-white">Giám sát cảm biến</h1>
  </div>

  <div class="table-responsive bg-white rounded shadow-sm">
    <table class="table table-striped mb-0">
      <thead class="bg-danger text-white">
        <tr>
          <th>Địa chỉ thiết bị</th>
          <th>Nhiệt độ (°C)</th>
          <th>Độ ẩm (%)</th>
          <th>Nồng độ gas</th>
          <th>Dấu báo lửa</th>
        </tr>
      </thead>
      <tbody id="sensor-body">
        <tr>
          <td colspan="5" class="text-center text-muted">Chưa có dữ liệu</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
async function loadData() {
  try {
    const response = await fetch("{{ url_for('api_data') }}");
    const data = await response.json();
    const tbody = document.getElementById('sensor-body');
    tbody.innerHTML = '';

    // Nhóm dữ liệu theo sid
    const rows = {};
    for (const [key, val] of Object.entries(data)) {
      const parts = key.split('_');
      const sid = parts[0];
      const field = parts[1];
      if (!rows[sid]) rows[sid] = { address: '', temp: '', hum: '', mq2: '', fire: '' };
      if (field === 'address') rows[sid].address = val;
      else if (field === 'temp') rows[sid].temp = val;
      else if (field === 'humi') rows[sid].hum = val;
      else if (field === 'mq2') rows[sid].mq2 = val;
      else if (field === 'fire') rows[sid].fire = val;
    }

    const sids = Object.keys(rows);
    if (sids.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="5" class="text-center text-muted">Chưa có dữ liệu</td>';
      tbody.appendChild(tr);
    } else {
      sids.forEach(sid => {
        const d = rows[sid];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${d.address || sid}</td>
          <td>${d.temp !== '' ? d.temp : '-'}</td>
          <td>${d.hum !== '' ? d.hum : '-'}</td>
          <td>${d.mq2 !== '' ? d.mq2 : '-'}</td>
          <td>${d.fire !== '' ? (d.fire == 1 ? 'Có' : 'Không') : '-'}</td>
        `;
        tbody.appendChild(tr);
      });
    }
  } catch (err) {
    console.error('Error loading data:', err);
  }
}

// Khi trang load xong và refresh định kỳ 5s
document.addEventListener('DOMContentLoaded', () => {
  loadData();
  setInterval(loadData, 5000);
});
</script>
{% endblock %}
