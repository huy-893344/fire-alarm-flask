{% extends "base.html" %}
{% block title %}Dashboard | Fire Alarm{% endblock %}

{% block body %}
<div class="bg-gray-800 py-10">
  <!-- Icon and Title Section -->
  <div class="container mx-auto text-center mb-8">
    <img src="{{ url_for('static', filename='img/node.png') }}" alt="Sensor Icon" class="mx-auto w-32 h-32 mb-4" />
    <h1 class="text-4xl font-bold text-white">Giám sát cảm biến</h1>
  </div>

  <!-- Data Table Section -->
  <div class="container mx-auto">
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Địa chỉ thiết bị</th>
            <th>Nhiệt độ (°C)</th>
            <th>Độ ẩm (%)</th>
            <th>Nồng độ gas</th>
            <th>Dấu báo lửa</th>
          </tr>
        </thead>
        <tbody id="sensor-data">
          <tr>
            <td colspan="5" class="text-center">Đang chờ dữ liệu...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyA3mHhx4atZVfMe-cxgU3hbqHl3ieHuD4U",
    authDomain: "tutrungtambaochay.firebaseapp.com",
    databaseURL: "https://tutrungtambaochay-default-rtdb.firebaseio.com",
    projectId: "tutrungtambaochay",
    storageBucket: "tutrungtambaochay.firebasestorage.app",
    messagingSenderId: "553147068654",
    appId: "1:553147068654:web:8274efbef19bacf47883ff"
  };
  firebase.initializeApp(firebaseConfig);

  // Real-time listener
  const dbRef = firebase.database().ref('DataSensorRealTime');
  dbRef.on('value', snapshot => {
    const data = snapshot.val() || {};
    const tbody = document.getElementById('sensor-data');
    tbody.innerHTML = '';

    if (Object.keys(data).length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center py-6">Chưa có dữ liệu</td></tr>';
      return;
    }

    for (const [sid, item] of Object.entries(data)) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.send_address || sid}</td>
        <td>${item.temperature ?? '—'}</td>
        <td>${item.humidity ?? '—'}</td>
        <td>${item.mq2 ?? '—'}</td>
        <td>${item.fire ? '<span class="text-red-600 font-semibold">Có</span>' : 'Không'}</td>
      `;
      tbody.appendChild(tr);
    }
  });
</script>
{% endblock %}
