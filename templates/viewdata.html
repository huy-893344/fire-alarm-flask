{% extends "base.html" %}
{% block title %}Dashboard | Fire Alarm{% endblock %}

{% block body %}
<div class="container py-5 text-center">
  <h1 class="mb-5">DASHBOARD</h1>

  <div class="mb-4">
    <h4>List Node</h4>
    <img src="{{ url_for('static', filename='img/node.png') }}"
         alt="Node" class="img-fluid rounded" style="max-width:200px;">
    <p class="mt-3 mb-4 fw-bold text-secondary">Đơn vị & Địa chỉ</p>
  </div>

  <h5 class="mb-3">Thông tin</h5>
  <div class="table-responsive">
    <table class="table table-striped mx-auto" style="max-width:800px;">
      <thead>
        <tr>
          <th>Địa chỉ thiết bị</th>
          <th>Nhiệt độ (℃)</th>
          <th>Độ ẩm (%)</th>
          <th>Gas (ppm)</th>
          <th>Fire</th>
        </tr>
      </thead>
      <tbody id="sensor-data">
        <!-- JS sẽ inject dữ liệu realtime ở đây -->
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script>
    function fetchRealtimeData() {
      fetch('/api/realtime')
        .then(response => response.json())
        .then(data => {
          const tableBody = document.getElementById("sensor-data");
          tableBody.innerHTML = '';

          Object.keys(data).forEach(sensor => {
            const d = data[sensor];
            const row = `
              <tr>
                <td>${d.address || sensor}</td>
                <td>${d.temperature ?? 'N/A'}</td>
                <td>${d.humidity ?? 'N/A'}</td>
                <td>${d.mq2 ?? 'N/A'}</td>
                <td>${d.fire ? 'Có' : 'Không'}</td>
              </tr>
            `;
            tableBody.innerHTML += row;
          });
        })
        .catch(error => {
          console.error("Lỗi lấy dữ liệu:", error);
        });
    }

    setInterval(fetchRealtimeData, 3000);
    window.onload = fetchRealtimeData;
  </script>
{% endblock %}
